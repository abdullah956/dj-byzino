{% extends 'base.html' %}
{% block title %}Order Details{% endblock %}

{% block content %}
    <h1>Order Details</h1>

    <div id="contract-detail" class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Order #{{ order.id }}</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Email:</strong> {{ order.email }}</p>
                    <p><strong>Amount:</strong> ${{ order.amount|floatformat:2 }}</p>
                    <p><strong>Order Date:</strong> {{ order.order_date }}</p>
                    <p><strong>Payment Method:</strong> {{ order.payment_method }}</p>
                    <p><strong>Status:</strong> {{ order.status }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Shipping Address:</strong> {{ order.shipping_address }}</p>
                    <p><strong>Billing Address:</strong> {{ order.billing_address }}</p>
                    <p><strong>Phone:</strong> {{ order.phone }}</p>
                    <p><strong>State:</strong> {{ order.state }}</p>
                    <p><strong>Country:</strong> {{ order.country }}</p>
                    <p><strong>City:</strong> {{ order.city }}</p>
                    <p><strong>Postal Code:</strong> {{ order.postal_code }}</p>
                </div>
            </div>

            <h3 class="mt-4">Products in this Order</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in products_with_quantities %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.quantity }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="2">No products found for this order.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <a href="{% url 'stats' %}" class="btn btn-secondary">Back to Dashboard</a>
    <button id="download-pdf" class="btn btn-secondary mt-4">Download PDF</button>
{% endblock %}

{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const downloadButton = document.getElementById('download-pdf')
        const contractElement = document.getElementById('contract-detail')
        const orderId = '{{ order.id }}' // Get the order ID from Django context
      
        if (downloadButton && contractElement) {
          downloadButton.addEventListener('click', () => {
            try {
              downloadButton.disabled = true
              downloadButton.textContent = 'Generating PDF...'
      
              const opt = {
                margin: 10,
                filename: `order-${orderId}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
              }
      
              html2pdf()
                .from(contractElement)
                .set(opt)
                .save()
                .then(() => {
                  console.log('PDF generated successfully')
                })
                .catch((error) => {
                  console.error('Error generating PDF:', error)
                  alert('Failed to generate PDF. Please try again.')
                })
                .finally(() => {
                  downloadButton.disabled = false
                  downloadButton.textContent = 'Download PDF'
                })
            } catch (error) {
              console.error('Error:', error)
              alert('Failed to generate PDF. Please try again.')
              downloadButton.disabled = false
              downloadButton.textContent = 'Download PDF'
            }
          })
        } else {
          console.error('Required elements not found. Check IDs: download-pdf, contract-detail')
        }
      })
    </script>
{% endblock %}
